<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZerohedgeQuant â€” Indian Market Intelligence</title>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* CSS VARIABLES & RESET */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg-primary: #0a0e17;
  --bg-secondary: #111827;
  --bg-card: #1a2035;
  --bg-hover: #243049;
  --border: #2a3555;
  --text-primary: #e8edf5;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --accent: #3b82f6;
  --accent2: #8b5cf6;
  --green: #22c55e;
  --red: #ef4444;
  --yellow: #eab308;
  --orange: #f97316;
  --cyan: #06b6d4;
  --nav-h: 52px;
  --ticker-h: 36px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  overflow-x: hidden;
  line-height: 1.5;
}

a { color: var(--accent); text-decoration: none; }
a:hover { text-decoration: underline; }

::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg-primary); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* TICKER BAR */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ticker-bar {
  height: var(--ticker-h);
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  overflow: hidden;
  font-size: 12px;
  position: fixed;
  top: 0; left: 0; right: 0;
  z-index: 1001;
}

.ticker-content {
  display: flex;
  gap: 28px;
  padding: 0 16px;
  animation: tickerScroll 40s linear infinite;
  white-space: nowrap;
}

@keyframes tickerScroll {
  0% { transform: translateX(0); }
  100% { transform: translateX(-50%); }
}

.ticker-item { display: flex; gap: 8px; align-items: center; }
.ticker-name { color: var(--text-secondary); font-weight: 500; }
.ticker-value { color: var(--text-primary); font-weight: 600; }
.ticker-change { font-weight: 600; font-size: 11px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* NAVIGATION */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.navbar {
  height: var(--nav-h);
  background: rgba(17, 24, 39, 0.95);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 24px;
  position: fixed;
  top: var(--ticker-h);
  left: 0; right: 0;
  z-index: 1000;
}

.nav-brand {
  font-size: 18px;
  font-weight: 700;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  cursor: pointer;
}

.nav-links { display: flex; gap: 4px; }

.nav-link {
  padding: 8px 14px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
  border: none;
  background: none;
}
.nav-link:hover { color: var(--text-primary); background: var(--bg-hover); }
.nav-link.active { color: var(--accent); background: rgba(59,130,246,0.1); }

.nav-right { display: flex; align-items: center; gap: 12px; }

.live-badge {
  display: flex; align-items: center; gap: 6px;
  font-size: 11px; font-weight: 600;
  color: var(--green);
  background: rgba(34,197,94,0.1);
  padding: 4px 10px; border-radius: 20px;
}
.live-dot {
  width: 7px; height: 7px;
  background: var(--green);
  border-radius: 50%;
  animation: pulse 1.5s infinite;
}
@keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }

.market-time { font-size: 11px; color: var(--text-muted); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* MAIN CONTENT */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main {
  margin-top: calc(var(--nav-h) + var(--ticker-h));
  padding: 20px 24px;
  max-width: 1440px;
  margin-left: auto;
  margin-right: auto;
}

.page { display: none; }
.page.active { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* HOME PAGE */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.home-search {
  max-width: 600px;
  margin: 0 auto 28px;
  position: relative;
}

.search-input {
  width: 100%;
  padding: 12px 18px 12px 42px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-primary);
  font-size: 15px;
  outline: none;
  transition: border 0.2s;
}
.search-input:focus { border-color: var(--accent); }
.search-input::placeholder { color: var(--text-muted); }

.search-icon {
  position: absolute;
  left: 14px; top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  font-size: 16px;
}

.search-results {
  position: absolute;
  top: 100%; left: 0; right: 0;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 0 0 10px 10px;
  max-height: 300px;
  overflow-y: auto;
  display: none;
  z-index: 100;
}
.search-results.show { display: block; }

.search-result-item {
  padding: 10px 16px;
  cursor: pointer;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.search-result-item:hover { background: var(--bg-hover); }
.sr-symbol { font-weight: 600; color: var(--accent); }
.sr-name { font-size: 13px; color: var(--text-secondary); }
.sr-sector { font-size: 11px; color: var(--text-muted); background: rgba(100,116,139,0.15); padding: 2px 8px; border-radius: 4px; }

/* Index cards */
.indices-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 14px;
  margin-bottom: 28px;
}

.index-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 16px;
  transition: transform 0.2s, border-color 0.2s;
}
.index-card:hover { transform: translateY(-2px); border-color: var(--accent); }

.idx-name { font-size: 12px; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
.idx-value { font-size: 22px; font-weight: 700; margin: 4px 0; }
.idx-change { font-size: 13px; font-weight: 600; }

/* Movers */
.movers-section { margin-bottom: 28px; }
.section-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.movers-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
}

.movers-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
}

.movers-header {
  padding: 12px 16px;
  font-weight: 600;
  font-size: 13px;
  border-bottom: 1px solid var(--border);
}

.mover-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 16px;
  border-bottom: 1px solid rgba(42,53,85,0.4);
  font-size: 13px;
  cursor: pointer;
  transition: background 0.15s;
}
.mover-row:hover { background: var(--bg-hover); }
.mover-symbol { font-weight: 600; color: var(--text-primary); min-width: 90px; }
.mover-price { color: var(--text-secondary); }
.mover-change { font-weight: 600; min-width: 70px; text-align: right; }

.up { color: var(--green); }
.down { color: var(--red); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* SCREENER */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.screener-tabs {
  display: flex;
  gap: 2px;
  margin-bottom: 2px;
  background: var(--bg-secondary);
  border-radius: 8px 8px 0 0;
  overflow: hidden;
  border: 1px solid var(--border);
  border-bottom: none;
}

.scr-tab {
  padding: 10px 20px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  color: var(--text-secondary);
  background: transparent;
  border: none;
  transition: all 0.15s;
}
.scr-tab:hover { color: var(--text-primary); background: var(--bg-hover); }
.scr-tab.active { color: var(--accent); background: var(--bg-card); font-weight: 600; }

.filter-panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-top: none;
  padding: 14px 16px;
  display: none;
}
.filter-panel.active { display: block; }

.filter-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 8px;
}

.filter-group { position: relative; }

.filter-select {
  width: 100%;
  padding: 7px 28px 7px 10px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--text-primary);
  font-size: 12px;
  cursor: pointer;
  outline: none;
  appearance: none;
  -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8'%3E%3Cpath d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 8px center;
}
.filter-select:focus { border-color: var(--accent); }
.filter-select option { background: var(--bg-secondary); color: var(--text-primary); }

.filter-actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid var(--border);
}

.btn {
  padding: 6px 16px;
  border-radius: 5px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  border: 1px solid var(--border);
  background: var(--bg-secondary);
  color: var(--text-primary);
  transition: all 0.15s;
}
.btn:hover { background: var(--bg-hover); }
.btn-primary { background: var(--accent); border-color: var(--accent); color: #fff; }
.btn-primary:hover { background: #2563eb; }

/* Sub-tabs row */
.screener-subtabs {
  display: flex;
  gap: 0;
  margin-bottom: 0;
  border: 1px solid var(--border);
  border-top: none;
  background: var(--bg-card);
  overflow-x: auto;
}

.sub-tab {
  padding: 8px 16px;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  color: var(--text-muted);
  background: none;
  border: none;
  border-right: 1px solid var(--border);
  white-space: nowrap;
  transition: all 0.15s;
}
.sub-tab:hover { color: var(--text-primary); background: var(--bg-hover); }
.sub-tab.active { color: var(--accent); background: rgba(59,130,246,0.08); }

/* Data table */
.table-wrapper {
  overflow-x: auto;
  border: 1px solid var(--border);
  border-top: none;
  border-radius: 0 0 8px 8px;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}

.data-table th {
  padding: 8px 12px;
  text-align: left;
  background: var(--bg-secondary);
  color: var(--text-muted);
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  cursor: pointer;
  white-space: nowrap;
  user-select: none;
}
.data-table th:hover { color: var(--text-primary); }
.data-table th.sorted { color: var(--accent); }

.data-table td {
  padding: 7px 12px;
  border-bottom: 1px solid rgba(42,53,85,0.3);
  white-space: nowrap;
}

.data-table tr:hover { background: var(--bg-hover); }

.data-table .stock-link {
  color: var(--accent);
  font-weight: 600;
  cursor: pointer;
}
.data-table .stock-link:hover { text-decoration: underline; }

/* Pagination */
.pagination {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-top: none;
  border-radius: 0 0 8px 8px;
  font-size: 12px;
  color: var(--text-muted);
}

.page-info { }
.page-btns { display: flex; gap: 4px; }
.page-btn {
  padding: 4px 10px;
  border-radius: 4px;
  border: 1px solid var(--border);
  background: var(--bg-secondary);
  color: var(--text-primary);
  font-size: 12px;
  cursor: pointer;
}
.page-btn:hover { background: var(--bg-hover); }
.page-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }
.page-btn:disabled { opacity: 0.4; cursor: not-allowed; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* OPTION CHAIN */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.oc-controls {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.oc-select {
  padding: 8px 14px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 13px;
  outline: none;
}
.oc-select option { background: var(--bg-secondary); }

.spot-display {
  margin-left: auto;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 16px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.spot-label { font-size: 12px; color: var(--text-muted); }
.spot-val { font-size: 18px; font-weight: 700; color: var(--accent); }

.oc-table-wrap { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; }

.oc-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}

.oc-table th {
  padding: 8px 10px;
  font-size: 11px;
  text-transform: uppercase;
  font-weight: 600;
  border-bottom: 2px solid var(--border);
  white-space: nowrap;
}

.oc-table .call-header { background: rgba(34,197,94,0.08); color: var(--green); }
.oc-table .put-header { background: rgba(239,68,68,0.08); color: var(--red); }
.oc-table .strike-header { background: var(--bg-secondary); color: var(--yellow); text-align: center; }

.oc-table td { padding: 6px 10px; border-bottom: 1px solid rgba(42,53,85,0.3); text-align: right; }

.oc-table .call-cell { background: rgba(34,197,94,0.03); }
.oc-table .put-cell { background: rgba(239,68,68,0.03); }
.oc-table .strike-cell {
  text-align: center;
  font-weight: 700;
  background: var(--bg-secondary);
  color: var(--yellow);
  font-size: 13px;
}
.oc-table .itm-call { background: rgba(34,197,94,0.08); }
.oc-table .itm-put { background: rgba(239,68,68,0.08); }
.oc-table .atm { background: rgba(234,179,8,0.12) !important; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* STOCK DETAIL PAGE */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stock-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 12px;
}

.stock-title-area h2 {
  font-size: 24px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 10px;
}

.stock-tag {
  font-size: 11px;
  padding: 3px 8px;
  border-radius: 4px;
  background: rgba(59,130,246,0.12);
  color: var(--accent);
  font-weight: 500;
}

.stock-price-area { text-align: right; }
.stock-price { font-size: 28px; font-weight: 700; }
.stock-change-line { font-size: 14px; font-weight: 600; }

.stock-stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 10px;
  margin-bottom: 24px;
}

.stat-box {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
}
.stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.3px; }
.stat-value { font-size: 16px; font-weight: 600; margin-top: 4px; }

.back-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 16px;
  padding: 6px 12px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 13px;
}
.back-btn:hover { color: var(--text-primary); border-color: var(--accent); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* RATING TRACKER */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rating-cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 14px;
  margin-bottom: 28px;
}

.rating-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 20px;
  display: flex;
  align-items: center;
  gap: 20px;
}

.accuracy-ring {
  width: 72px; height: 72px;
  position: relative;
  flex-shrink: 0;
}

.accuracy-ring svg { width: 100%; height: 100%; transform: rotate(-90deg); }
.accuracy-ring circle {
  fill: none;
  stroke-width: 5;
  cx: 36; cy: 36; r: 30;
}
.ring-bg { stroke: var(--border); }
.ring-val { stroke-linecap: round; transition: stroke-dashoffset 1s ease; }

.ring-text {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  font-weight: 700;
}

.rating-info h3 { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
.rating-type { font-size: 12px; color: var(--text-muted); }
.rating-stat { font-size: 12px; color: var(--text-secondary); margin-top: 6px; }

.recent-calls { margin-top: 24px; }

.call-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
}

.call-table th {
  padding: 10px 14px;
  text-align: left;
  background: var(--bg-secondary);
  color: var(--text-muted);
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
}

.call-table td { padding: 8px 14px; border-bottom: 1px solid rgba(42,53,85,0.3); }

.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
}
.badge-buy { background: rgba(34,197,94,0.12); color: var(--green); }
.badge-sell { background: rgba(239,68,68,0.12); color: var(--red); }
.badge-hold { background: rgba(234,179,8,0.12); color: var(--yellow); }
.badge-hit { background: rgba(34,197,94,0.12); color: var(--green); }
.badge-miss { background: rgba(239,68,68,0.12); color: var(--red); }
.badge-active { background: rgba(59,130,246,0.12); color: var(--accent); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* LEARNING HUB */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.learning-cats {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.cat-btn {
  padding: 6px 16px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--bg-card);
  color: var(--text-secondary);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s;
}
.cat-btn:hover, .cat-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

.articles-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 16px;
}

.article-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.2s;
}
.article-card:hover { transform: translateY(-2px); border-color: var(--accent); }

.article-level {
  display: inline-block;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  padding: 2px 8px;
  border-radius: 4px;
  margin-bottom: 8px;
}
.level-beginner { background: rgba(34,197,94,0.12); color: var(--green); }
.level-intermediate { background: rgba(234,179,8,0.12); color: var(--yellow); }
.level-advanced { background: rgba(239,68,68,0.12); color: var(--red); }

.article-title { font-size: 15px; font-weight: 600; margin-bottom: 6px; }
.article-desc { font-size: 13px; color: var(--text-secondary); line-height: 1.5; }
.article-meta { margin-top: 10px; font-size: 11px; color: var(--text-muted); display: flex; gap: 16px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* LOADING */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.loading-row td { text-align: center; padding: 40px; color: var(--text-muted); }
.spinner {
  width: 28px; height: 28px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 8px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* RESPONSIVE */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 768px) {
  .main { padding: 14px; }
  .navbar { padding: 0 12px; }
  .nav-links { gap: 0; }
  .nav-link { padding: 6px 8px; font-size: 12px; }
  .movers-grid { grid-template-columns: 1fr; }
  .indices-grid { grid-template-columns: repeat(2, 1fr); }
  .filter-grid { grid-template-columns: repeat(2, 1fr); }
  .oc-controls { flex-direction: column; align-items: stretch; }
  .spot-display { margin-left: 0; }
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â• TICKER BAR â•â•â•â•â•â•â•â•â•â•â• -->
<div class="ticker-bar">
  <div class="ticker-content" id="tickerContent">
    <span class="ticker-item"><span class="ticker-name">Loading market data...</span></span>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• NAVBAR â•â•â•â•â•â•â•â•â•â•â• -->
<nav class="navbar">
  <div class="nav-brand" onclick="showPage('home')">ZerohedgeQuant</div>
  <div class="nav-links">
    <button class="nav-link active" onclick="showPage('home')">Home</button>
    <button class="nav-link" onclick="showPage('screener')">Screener</button>
    <button class="nav-link" onclick="showPage('optionchain')">Option Chain</button>
    <button class="nav-link" onclick="showPage('ratings')">Rating Tracker</button>
    <button class="nav-link" onclick="showPage('learning')">Learning Hub</button>
  </div>
  <div class="nav-right">
    <div class="live-badge" id="liveBadge">
      <span class="live-dot"></span>
      <span id="liveStatus">Connecting...</span>
    </div>
    <div class="market-time" id="marketTime"></div>
  </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â• MAIN CONTENT â•â•â•â•â•â•â•â•â•â•â• -->
<div class="main">

  <!-- â•â•â•â•â•â•â•â•â•â•â• HOME â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="home" class="page active">
    <div class="home-search">
      <span class="search-icon">ğŸ”</span>
      <input class="search-input" id="searchInput" type="text" placeholder="Search stocks â€” try RELIANCE, TCS, Infosys..." autocomplete="off">
      <div class="search-results" id="searchResults"></div>
    </div>

    <div class="indices-grid" id="indicesGrid">
      <div class="index-card"><div class="idx-name">NIFTY 50</div><div class="idx-value">--</div><div class="idx-change">--</div></div>
      <div class="index-card"><div class="idx-name">BANK NIFTY</div><div class="idx-value">--</div><div class="idx-change">--</div></div>
      <div class="index-card"><div class="idx-name">NIFTY IT</div><div class="idx-value">--</div><div class="idx-change">--</div></div>
      <div class="index-card"><div class="idx-name">FIN NIFTY</div><div class="idx-value">--</div><div class="idx-change">--</div></div>
    </div>

    <div class="movers-section">
      <div class="section-title">ğŸ“ˆ Market Movers</div>
      <div class="movers-grid">
        <div class="movers-card">
          <div class="movers-header" style="color:var(--green)">â–² Top Gainers</div>
          <div id="topGainers"><div class="mover-row"><span class="mover-symbol" style="color:var(--text-muted)">Loading...</span></div></div>
        </div>
        <div class="movers-card">
          <div class="movers-header" style="color:var(--red)">â–¼ Top Losers</div>
          <div id="topLosers"><div class="mover-row"><span class="mover-symbol" style="color:var(--text-muted)">Loading...</span></div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• SCREENER â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="screener" class="page">
    <!-- Primary tabs -->
    <div class="screener-tabs">
      <button class="scr-tab active" onclick="switchScreenerTab('descriptive')">Descriptive</button>
      <button class="scr-tab" onclick="switchScreenerTab('fundamental')">Fundamental</button>
      <button class="scr-tab" onclick="switchScreenerTab('technical')">Technical</button>
    </div>

    <!-- DESCRIPTIVE FILTERS -->
    <div class="filter-panel active" id="filter-descriptive">
      <div class="filter-grid">
        <div class="filter-group">
          <select class="filter-select" id="f-exchange"><option value="">Exchange</option><option>NSE</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-index"><option value="">Index</option><option value="Nifty 50">Nifty 50</option><option value="All">All Stocks</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-sector"><option value="">Sector</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-industry"><option value="">Industry</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-mcap"><option value="">Market Cap</option><option>Mega (&gt;1L Cr)</option><option>Large (25K-1L Cr)</option><option>Mid (5K-25K Cr)</option><option>Small (&lt;5K Cr)</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-dividend"><option value="">Dividend Yield</option><option>High (&gt;3%)</option><option>Medium (1-3%)</option><option>Low (&lt;1%)</option><option>None (0%)</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-price"><option value="">Price</option><option>Under â‚¹100</option><option>â‚¹100-500</option><option>â‚¹500-2000</option><option>â‚¹2000-5000</option><option>Over â‚¹5000</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-change"><option value="">Change</option><option>Up &gt;5%</option><option>Up &gt;2%</option><option>Up</option><option>Down</option><option>Down &gt;2%</option><option>Down &gt;5%</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-volume"><option value="">Volume</option><option>Over 10M</option><option>Over 5M</option><option>Over 1M</option><option>Under 1M</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-analyst"><option value="">Analyst Rec.</option><option>Strong Buy</option><option>Buy</option><option>Hold</option><option>Sell</option><option>Strong Sell</option></select>
        </div>
      </div>
      <div class="filter-actions">
        <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
        <button class="btn" onclick="resetFilters()">Reset</button>
        <span style="margin-left:auto;font-size:12px;color:var(--text-muted)" id="filterCount">50 stocks</span>
      </div>
    </div>

    <!-- FUNDAMENTAL FILTERS -->
    <div class="filter-panel" id="filter-fundamental">
      <div class="filter-grid">
        <div class="filter-group">
          <select class="filter-select" id="f-pe"><option value="">P/E</option><option>Under 10</option><option>Under 15</option><option>Under 20</option><option>Under 30</option><option>Over 30</option><option>Over 50</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-fwdpe"><option value="">Forward P/E</option><option>Under 10</option><option>Under 15</option><option>Under 20</option><option>Over 20</option><option>Over 30</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-peg"><option value="">PEG</option><option>Under 1</option><option>Under 1.5</option><option>Under 2</option><option>Over 2</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-ps"><option value="">P/S</option><option>Under 2</option><option>Under 5</option><option>Under 10</option><option>Over 10</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-pb"><option value="">P/B</option><option>Under 1</option><option>Under 2</option><option>Under 3</option><option>Under 5</option><option>Over 5</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-eveb"><option value="">EV/EBITDA</option><option>Under 10</option><option>Under 15</option><option>Under 20</option><option>Over 20</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-roe"><option value="">ROE</option><option>Over 30%</option><option>Over 20%</option><option>Over 15%</option><option>Over 10%</option><option>Under 10%</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-roa"><option value="">ROA</option><option>Over 15%</option><option>Over 10%</option><option>Over 5%</option><option>Under 5%</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-de"><option value="">Debt/Equity</option><option>Under 0.5</option><option>Under 1</option><option>Under 2</option><option>Over 2</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-gm"><option value="">Gross Margin</option><option>Over 50%</option><option>Over 30%</option><option>Over 20%</option><option>Under 20%</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-om"><option value="">Operating Margin</option><option>Over 30%</option><option>Over 20%</option><option>Over 10%</option><option>Under 10%</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-nm"><option value="">Net Margin</option><option>Over 20%</option><option>Over 15%</option><option>Over 10%</option><option>Under 10%</option></select>
        </div>
      </div>
      <div class="filter-actions">
        <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
        <button class="btn" onclick="resetFilters()">Reset</button>
        <span style="margin-left:auto;font-size:12px;color:var(--text-muted)" id="filterCount2">50 stocks</span>
      </div>
    </div>

    <!-- TECHNICAL FILTERS -->
    <div class="filter-panel" id="filter-technical">
      <div class="filter-grid">
        <div class="filter-group">
          <select class="filter-select" id="f-rsi"><option value="">RSI (14)</option><option>Overbought (&gt;70)</option><option>60-70</option><option>50-60</option><option>40-50</option><option>Oversold (&lt;30)</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-sma20"><option value="">Price vs SMA20</option><option>Above SMA20</option><option>Below SMA20</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-sma50"><option value="">Price vs SMA50</option><option>Above SMA50</option><option>Below SMA50</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-sma200"><option value="">Price vs SMA200</option><option>Above SMA200</option><option>Below SMA200</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-perf1w"><option value="">Perf Week</option><option>Up &gt;5%</option><option>Up &gt;2%</option><option>Up</option><option>Down</option><option>Down &gt;5%</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-perf1m"><option value="">Perf Month</option><option>Up &gt;10%</option><option>Up &gt;5%</option><option>Up</option><option>Down</option><option>Down &gt;10%</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-vol"><option value="">Volatility</option><option>High (&gt;4%)</option><option>Medium (2-4%)</option><option>Low (&lt;2%)</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-beta"><option value="">Beta</option><option>Over 1.5</option><option>Over 1</option><option>Under 1</option><option>Under 0.5</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-gap"><option value="">Gap</option><option>Up &gt;2%</option><option>Up</option><option>Down</option><option>Down &gt;2%</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-52w"><option value="">52W High/Low</option><option>Near 52W High (&lt;5%)</option><option>Near 52W Low (&lt;5%)</option><option>Above 52W Low &gt;50%</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-pattern"><option value="">Pattern</option><option>Double Bottom</option><option>Head & Shoulders</option><option>Ascending Triangle</option><option>Channel Up</option><option>Wedge Down</option><option>Cup & Handle</option></select>
        </div>
        <div class="filter-group">
          <select class="filter-select" id="f-candle"><option value="">Candlestick</option><option>Hammer</option><option>Doji</option><option>Engulfing</option><option>Morning Star</option><option>Spinning Top</option><option>Marubozu</option></select>
        </div>
      </div>
      <div class="filter-actions">
        <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
        <button class="btn" onclick="resetFilters()">Reset</button>
        <span style="margin-left:auto;font-size:12px;color:var(--text-muted)" id="filterCount3">50 stocks</span>
      </div>
    </div>

    <!-- Sub-tabs (Overview, Valuation, etc.) -->
    <div class="screener-subtabs">
      <button class="sub-tab active" onclick="switchSubTab('overview')">Overview</button>
      <button class="sub-tab" onclick="switchSubTab('valuation')">Valuation</button>
      <button class="sub-tab" onclick="switchSubTab('financial')">Financial</button>
      <button class="sub-tab" onclick="switchSubTab('performance')">Performance</button>
      <button class="sub-tab" onclick="switchSubTab('technical')">Technical</button>
    </div>

    <!-- Table -->
    <div class="table-wrapper">
      <table class="data-table" id="screenerTable">
        <thead id="screenerHead"></thead>
        <tbody id="screenerBody">
          <tr class="loading-row"><td colspan="10"><div class="spinner"></div>Loading data...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="pagination" id="screenerPagination"></div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• OPTION CHAIN â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="optionchain" class="page">
    <div class="section-title">ğŸ“Š Option Chain</div>
    <div class="oc-controls">
      <select class="oc-select" id="ocUnderlying">
        <option value="NIFTY">NIFTY 50</option>
        <option value="BANKNIFTY">BANK NIFTY</option>
        <option value="FINNIFTY">FIN NIFTY</option>
        <optgroup label="Stocks">
          <option value="RELIANCE">RELIANCE</option>
          <option value="TCS">TCS</option>
          <option value="HDFCBANK">HDFC BANK</option>
          <option value="INFY">INFOSYS</option>
          <option value="ICICIBANK">ICICI BANK</option>
          <option value="SBIN">SBI</option>
          <option value="BHARTIARTL">BHARTI AIRTEL</option>
          <option value="ITC">ITC</option>
          <option value="KOTAKBANK">KOTAK BANK</option>
          <option value="LT">L&T</option>
          <option value="TATAMOTORS">TATA MOTORS</option>
          <option value="BAJFINANCE">BAJAJ FINANCE</option>
        </optgroup>
      </select>
      <select class="oc-select" id="ocExpiry">
        <option>Loading expiries...</option>
      </select>
      <button class="btn btn-primary" onclick="loadOptionChain()">Load</button>
      <div class="spot-display">
        <span class="spot-label">Spot Price</span>
        <span class="spot-val" id="ocSpot">--</span>
      </div>
    </div>

    <div class="oc-table-wrap">
      <table class="oc-table" id="ocTable">
        <thead>
          <tr>
            <th class="call-header">OI</th>
            <th class="call-header">Chg OI</th>
            <th class="call-header">Vol</th>
            <th class="call-header">IV</th>
            <th class="call-header">LTP</th>
            <th class="call-header">Chg</th>
            <th class="strike-header">STRIKE</th>
            <th class="put-header">Chg</th>
            <th class="put-header">LTP</th>
            <th class="put-header">IV</th>
            <th class="put-header">Vol</th>
            <th class="put-header">Chg OI</th>
            <th class="put-header">OI</th>
          </tr>
        </thead>
        <tbody id="ocBody">
          <tr><td colspan="13" style="text-align:center;padding:40px;color:var(--text-muted)">Select underlying and click Load</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• STOCK DETAIL â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="stockdetail" class="page">
    <div class="back-btn" onclick="history.back(); showPage(lastPage || 'screener')">â† Back</div>
    <div id="stockDetailContent"></div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• RATING TRACKER â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="ratings" class="page">
    <div class="section-title">ğŸ¯ Rating Tracker â€” Analyst Credibility</div>
    <div class="rating-cards" id="ratingCards"></div>
    <div class="recent-calls">
      <div class="section-title">Recent Analyst Calls</div>
      <table class="call-table" id="callsTable">
        <thead>
          <tr><th>Agency</th><th>Stock</th><th>Rating</th><th>Target</th><th>CMP</th><th>Upside</th><th>Date</th><th>Status</th></tr>
        </thead>
        <tbody id="callsBody"></tbody>
      </table>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• LEARNING HUB â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="learning" class="page">
    <div class="section-title">ğŸ“š Learning Hub â€” Quantitative Finance</div>
    <div class="learning-cats">
      <button class="cat-btn active" onclick="filterArticles('all')">All</button>
      <button class="cat-btn" onclick="filterArticles('beginner')">Beginner</button>
      <button class="cat-btn" onclick="filterArticles('intermediate')">Intermediate</button>
      <button class="cat-btn" onclick="filterArticles('advanced')">Advanced</button>
    </div>
    <div class="articles-grid" id="articlesGrid"></div>
  </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_URL = 'https://zerohedgequant-backend.onrender.com';
let screenerData = [];
let filteredData = [];
let currentPage = 1;
let lastPage = 'home';
let currentSubTab = 'overview';
let currentSort = { col: 'changePct', dir: 'desc' };
const PAGE_SIZE = 20;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(id) {
  if (id !== 'stockdetail') lastPage = id;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
  document.querySelectorAll('.nav-link').forEach(n => {
    if (n.textContent.toLowerCase().replace(/\s/g,'').includes(id.replace('optionchain','optionchain').replace('ratings','ratingtracker').replace('learning','learninghub'))) {
      // match loosely
    }
  });
  // Simpler approach
  const map = { home:0, screener:1, optionchain:2, ratings:3, learning:4 };
  const links = document.querySelectorAll('.nav-link');
  if (map[id] !== undefined && links[map[id]]) links[map[id]].classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIME DISPLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateTime() {
  const now = new Date();
  const ist = now.toLocaleString('en-IN', { timeZone: 'Asia/Kolkata', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
  document.getElementById('marketTime').textContent = ist + ' IST';
}
setInterval(updateTime, 1000);
updateTime();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API FETCH HELPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function apiFetch(path) {
  try {
    const res = await fetch(`${API_URL}${path}`, { timeout: 15000 });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    return json;
  } catch (e) {
    console.error(`API Error [${path}]:`, e);
    return null;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INDICES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadIndices() {
  const res = await apiFetch('/api/indices');
  if (!res?.success || !res.data) return;

  const d = res.data;
  const grid = document.getElementById('indicesGrid');
  const items = [
    { key: 'NIFTY50', label: 'NIFTY 50' },
    { key: 'BANKNIFTY', label: 'BANK NIFTY' },
    { key: 'NIFTYIT', label: 'NIFTY IT' },
    { key: 'FINNIFTY', label: 'FIN NIFTY' },
  ];

  grid.innerHTML = items.map(i => {
    const v = d[i.key];
    if (!v || !v.value) return `<div class="index-card"><div class="idx-name">${i.label}</div><div class="idx-value">--</div><div class="idx-change">--</div></div>`;
    const up = v.changePct >= 0;
    return `<div class="index-card">
      <div class="idx-name">${i.label}</div>
      <div class="idx-value">${v.value.toLocaleString('en-IN', {maximumFractionDigits:2})}</div>
      <div class="idx-change ${up?'up':'down'}">${up?'â–²':'â–¼'} ${v.change>=0?'+':''}${v.change.toFixed(2)} (${v.changePct>=0?'+':''}${v.changePct.toFixed(2)}%)</div>
    </div>`;
  }).join('');

  // Update ticker
  updateTicker(d);

  // Update live status
  const hasData = Object.values(d).some(v => v && v.value > 0);
  document.getElementById('liveStatus').textContent = hasData ? 'LIVE via Upstox' : 'Offline';
  document.getElementById('liveBadge').style.color = hasData ? 'var(--green)' : 'var(--red)';
}

function updateTicker(indices) {
  const items = [];
  const names = { NIFTY50: 'NIFTY 50', BANKNIFTY: 'BANK NIFTY', NIFTYIT: 'NIFTY IT', FINNIFTY: 'FIN NIFTY' };
  for (const [key, val] of Object.entries(indices)) {
    if (!val || !val.value) continue;
    const up = val.changePct >= 0;
    items.push(`<span class="ticker-item">
      <span class="ticker-name">${names[key] || key}</span>
      <span class="ticker-value">${val.value.toLocaleString('en-IN',{maximumFractionDigits:2})}</span>
      <span class="ticker-change ${up?'up':'down'}">${up?'+':''}${val.changePct.toFixed(2)}%</span>
    </span>`);
  }

  // Add some stock data from screener if available
  if (screenerData.length > 0) {
    const topStocks = [...screenerData].sort((a,b) => Math.abs(b.changePct) - Math.abs(a.changePct)).slice(0, 8);
    topStocks.forEach(s => {
      if (!s.price) return;
      const up = s.changePct >= 0;
      items.push(`<span class="ticker-item">
        <span class="ticker-name">${s.symbol}</span>
        <span class="ticker-value">â‚¹${s.price.toLocaleString('en-IN',{maximumFractionDigits:2})}</span>
        <span class="ticker-change ${up?'up':'down'}">${up?'+':''}${s.changePct.toFixed(2)}%</span>
      </span>`);
    });
  }

  if (items.length > 0) {
    const doubled = items.join('') + items.join(''); // duplicate for seamless scroll
    document.getElementById('tickerContent').innerHTML = doubled;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MARKET DATA & MOVERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadMarketData() {
  const res = await apiFetch('/api/market-data');
  if (!res?.success || !res.data) return;

  const stocks = Object.values(res.data).filter(s => s.price > 0);

  // Top Gainers
  const gainers = [...stocks].sort((a,b) => b.changePct - a.changePct).slice(0, 5);
  document.getElementById('topGainers').innerHTML = gainers.map(s =>
    `<div class="mover-row" onclick="showStock('${s.symbol}')">
      <span class="mover-symbol">${s.symbol}</span>
      <span class="mover-price">â‚¹${s.price.toLocaleString('en-IN',{maximumFractionDigits:2})}</span>
      <span class="mover-change up">+${s.changePct.toFixed(2)}%</span>
    </div>`
  ).join('') || '<div class="mover-row"><span style="color:var(--text-muted)">No data</span></div>';

  // Top Losers
  const losers = [...stocks].sort((a,b) => a.changePct - b.changePct).slice(0, 5);
  document.getElementById('topLosers').innerHTML = losers.map(s =>
    `<div class="mover-row" onclick="showStock('${s.symbol}')">
      <span class="mover-symbol">${s.symbol}</span>
      <span class="mover-price">â‚¹${s.price.toLocaleString('en-IN',{maximumFractionDigits:2})}</span>
      <span class="mover-change down">${s.changePct.toFixed(2)}%</span>
    </div>`
  ).join('') || '<div class="mover-row"><span style="color:var(--text-muted)">No data</span></div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const searchInput = document.getElementById('searchInput');
const searchResults = document.getElementById('searchResults');
let searchTimeout;

searchInput.addEventListener('input', () => {
  clearTimeout(searchTimeout);
  const q = searchInput.value.trim();
  if (!q) { searchResults.classList.remove('show'); return; }
  searchTimeout = setTimeout(async () => {
    const res = await apiFetch(`/api/search?q=${encodeURIComponent(q)}`);
    if (!res?.success || !res.data.length) { searchResults.classList.remove('show'); return; }
    searchResults.innerHTML = res.data.map(s =>
      `<div class="search-result-item" onclick="showStock('${s.symbol}')">
        <div><span class="sr-symbol">${s.symbol}</span> <span class="sr-name">${s.name}</span></div>
        <span class="sr-sector">${s.sector}</span>
      </div>`
    ).join('');
    searchResults.classList.add('show');
  }, 250);
});

searchInput.addEventListener('blur', () => setTimeout(() => searchResults.classList.remove('show'), 200));
searchInput.addEventListener('focus', () => { if (searchInput.value.trim()) searchInput.dispatchEvent(new Event('input')); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREENER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadScreener() {
  const res = await apiFetch('/api/screener');
  if (!res?.success || !res.data) return;

  screenerData = res.data;
  populateFilterDropdowns();
  filteredData = [...screenerData];
  currentPage = 1;
  renderScreenerTable();
}

function populateFilterDropdowns() {
  const sectors = [...new Set(screenerData.map(s => s.sector).filter(Boolean))].sort();
  const industries = [...new Set(screenerData.map(s => s.industry).filter(Boolean))].sort();

  const sectorSel = document.getElementById('f-sector');
  sectorSel.innerHTML = '<option value="">Sector</option>' + sectors.map(s => `<option>${s}</option>`).join('');

  const industrySel = document.getElementById('f-industry');
  industrySel.innerHTML = '<option value="">Industry</option>' + industries.map(i => `<option>${i}</option>`).join('');
}

function switchScreenerTab(tab) {
  document.querySelectorAll('.scr-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.filter-panel').forEach(p => p.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById(`filter-${tab}`).classList.add('active');
}

function switchSubTab(tab) {
  currentSubTab = tab;
  document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  renderScreenerTable();
}

// â”€â”€ FILTER LOGIC â”€â”€
function applyFilters() {
  filteredData = screenerData.filter(s => {
    // Descriptive
    if (val('f-sector') && s.sector !== val('f-sector')) return false;
    if (val('f-industry') && s.industry !== val('f-industry')) return false;
    if (val('f-analyst') && s.analystRec !== val('f-analyst')) return false;

    const price = s.price || 0;
    const pf = val('f-price');
    if (pf === 'Under â‚¹100' && price >= 100) return false;
    if (pf === 'â‚¹100-500' && (price < 100 || price >= 500)) return false;
    if (pf === 'â‚¹500-2000' && (price < 500 || price >= 2000)) return false;
    if (pf === 'â‚¹2000-5000' && (price < 2000 || price >= 5000)) return false;
    if (pf === 'Over â‚¹5000' && price < 5000) return false;

    const chg = s.changePct || 0;
    const cf = val('f-change');
    if (cf === 'Up >5%' && chg <= 5) return false;
    if (cf === 'Up >2%' && chg <= 2) return false;
    if (cf === 'Up' && chg <= 0) return false;
    if (cf === 'Down' && chg >= 0) return false;
    if (cf === 'Down >2%' && chg >= -2) return false;
    if (cf === 'Down >5%' && chg >= -5) return false;

    const vol = s.volume || 0;
    const vf = val('f-volume');
    if (vf === 'Over 10M' && vol < 10000000) return false;
    if (vf === 'Over 5M' && vol < 5000000) return false;
    if (vf === 'Over 1M' && vol < 1000000) return false;
    if (vf === 'Under 1M' && vol >= 1000000) return false;

    const div = s.dividend || 0;
    const df = val('f-dividend');
    if (df === 'High (>3%)' && div <= 3) return false;
    if (df === 'Medium (1-3%)' && (div < 1 || div > 3)) return false;
    if (df === 'Low (<1%)' && (div >= 1 || div === 0)) return false;
    if (df === 'None (0%)' && div > 0) return false;

    // Fundamental
    if (!matchRange('f-pe', s.pe, [[/Under 10/,0,10],[/Under 15/,0,15],[/Under 20/,0,20],[/Under 30/,0,30],[/Over 30/,30,9999],[/Over 50/,50,9999]])) return false;
    if (!matchRange('f-fwdpe', s.fwdPe, [[/Under 10/,0,10],[/Under 15/,0,15],[/Under 20/,0,20],[/Over 20/,20,9999],[/Over 30/,30,9999]])) return false;
    if (!matchRange('f-peg', s.peg, [[/Under 1$/,0,1],[/Under 1.5/,0,1.5],[/Under 2/,0,2],[/Over 2/,2,9999]])) return false;
    if (!matchRange('f-ps', s.ps, [[/Under 2/,0,2],[/Under 5/,0,5],[/Under 10/,0,10],[/Over 10/,10,9999]])) return false;
    if (!matchRange('f-pb', s.pb, [[/Under 1$/,0,1],[/Under 2/,0,2],[/Under 3/,0,3],[/Under 5/,0,5],[/Over 5/,5,9999]])) return false;
    if (!matchRange('f-eveb', s.evEbitda, [[/Under 10/,0,10],[/Under 15/,0,15],[/Under 20/,0,20],[/Over 20/,20,9999]])) return false;
    if (!matchOver('f-roe', s.roe)) return false;
    if (!matchOver('f-roa', s.roa)) return false;
    if (!matchRange('f-de', s.debtEquity, [[/Under 0.5/,0,0.5],[/Under 1$/,0,1],[/Under 2/,0,2],[/Over 2/,2,9999]])) return false;
    if (!matchOver('f-gm', s.grossMargin)) return false;
    if (!matchOver('f-om', s.operatingMargin)) return false;
    if (!matchOver('f-nm', s.netMargin)) return false;

    // Technical
    const rsi = s.rsi || 50;
    const rf = val('f-rsi');
    if (rf === 'Overbought (>70)' && rsi <= 70) return false;
    if (rf === '60-70' && (rsi < 60 || rsi > 70)) return false;
    if (rf === '50-60' && (rsi < 50 || rsi > 60)) return false;
    if (rf === '40-50' && (rsi < 40 || rsi > 50)) return false;
    if (rf === 'Oversold (<30)' && rsi >= 30) return false;

    if (val('f-sma20') === 'Above SMA20' && price <= (s.sma20||0)) return false;
    if (val('f-sma20') === 'Below SMA20' && price >= (s.sma20||0)) return false;
    if (val('f-sma50') === 'Above SMA50' && price <= (s.sma50||0)) return false;
    if (val('f-sma50') === 'Below SMA50' && price >= (s.sma50||0)) return false;
    if (val('f-sma200') === 'Above SMA200' && price <= (s.sma200||0)) return false;
    if (val('f-sma200') === 'Below SMA200' && price >= (s.sma200||0)) return false;

    if (!matchPerf('f-perf1w', s.perf1w)) return false;
    if (!matchPerf('f-perf1m', s.perf1m)) return false;

    const beta = s.beta || 1;
    const bf = val('f-beta');
    if (bf === 'Over 1.5' && beta <= 1.5) return false;
    if (bf === 'Over 1' && beta <= 1) return false;
    if (bf === 'Under 1' && beta >= 1) return false;
    if (bf === 'Under 0.5' && beta >= 0.5) return false;

    if (val('f-pattern') && s.pattern !== val('f-pattern')) return false;
    if (val('f-candle') && s.candlestick !== val('f-candle')) return false;

    return true;
  });

  currentPage = 1;
  renderScreenerTable();
  updateFilterCounts();
}

function matchRange(id, value, ranges) {
  const v = val(id);
  if (!v) return true;
  for (const [regex, min, max] of ranges) {
    if (regex.test(v)) return value >= min && value < max;
  }
  return true;
}

function matchOver(id, value) {
  const v = val(id);
  if (!v) return true;
  const m = v.match(/(Over|Under)\s+(\d+)/);
  if (!m) return true;
  const threshold = parseFloat(m[2]);
  return m[1] === 'Over' ? value >= threshold : value < threshold;
}

function matchPerf(id, value) {
  const v = val(id);
  if (!v) return true;
  if (v.includes('>10%')) return value > 10;
  if (v.includes('>5%') && v.includes('Up')) return value > 5;
  if (v.includes('>2%') && v.includes('Up')) return value > 2;
  if (v === 'Up') return value > 0;
  if (v === 'Down') return value < 0;
  if (v.includes('>5%') && v.includes('Down')) return value < -5;
  if (v.includes('>10%') && v.includes('Down')) return value < -10;
  return true;
}

function val(id) { const el = document.getElementById(id); return el ? el.value : ''; }

function resetFilters() {
  document.querySelectorAll('.filter-select').forEach(s => s.selectedIndex = 0);
  filteredData = [...screenerData];
  currentPage = 1;
  renderScreenerTable();
  updateFilterCounts();
}

function updateFilterCounts() {
  const txt = `${filteredData.length} stock${filteredData.length!==1?'s':''}`;
  ['filterCount','filterCount2','filterCount3'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = txt;
  });
}

// â”€â”€ TABLE COLUMNS BY SUB-TAB â”€â”€
function getColumns() {
  const base = [
    { key:'symbol', label:'Ticker', fmt: (v,s) => `<span class="stock-link" onclick="showStock('${s.symbol}')">${v}</span>` },
    { key:'name', label:'Company' },
  ];

  const cols = {
    overview: [
      ...base,
      { key:'sector', label:'Sector' },
      { key:'industry', label:'Industry' },
      { key:'price', label:'Price', fmt: v => v ? 'â‚¹'+v.toLocaleString('en-IN',{maximumFractionDigits:2}) : '--' },
      { key:'changePct', label:'Change', fmt: v => `<span class="${v>=0?'up':'down'}">${v>=0?'+':''}${(v||0).toFixed(2)}%</span>` },
      { key:'volume', label:'Volume', fmt: v => v ? formatNum(v) : '--' },
      { key:'marketCap', label:'Mkt Cap', fmt: v => v ? 'â‚¹'+formatCr(v) : '--' },
      { key:'pe', label:'P/E' },
      { key:'dividend', label:'Div %' },
    ],
    valuation: [
      ...base,
      { key:'price', label:'Price', fmt: v => v ? 'â‚¹'+v.toLocaleString('en-IN',{maximumFractionDigits:2}) : '--' },
      { key:'pe', label:'P/E' },
      { key:'fwdPe', label:'Fwd P/E' },
      { key:'peg', label:'PEG' },
      { key:'ps', label:'P/S' },
      { key:'pb', label:'P/B' },
      { key:'evEbitda', label:'EV/EBITDA' },
      { key:'eps', label:'EPS' },
      { key:'marketCap', label:'Mkt Cap', fmt: v => v ? 'â‚¹'+formatCr(v) : '--' },
    ],
    financial: [
      ...base,
      { key:'price', label:'Price', fmt: v => v ? 'â‚¹'+v.toLocaleString('en-IN',{maximumFractionDigits:2}) : '--' },
      { key:'roe', label:'ROE %' },
      { key:'roa', label:'ROA %' },
      { key:'debtEquity', label:'D/E' },
      { key:'grossMargin', label:'Gross M%' },
      { key:'operatingMargin', label:'Oper M%' },
      { key:'netMargin', label:'Net M%' },
      { key:'dividend', label:'Div %' },
      { key:'eps', label:'EPS' },
    ],
    performance: [
      ...base,
      { key:'price', label:'Price', fmt: v => v ? 'â‚¹'+v.toLocaleString('en-IN',{maximumFractionDigits:2}) : '--' },
      { key:'changePct', label:'Today', fmt: v => `<span class="${v>=0?'up':'down'}">${v>=0?'+':''}${(v||0).toFixed(2)}%</span>` },
      { key:'perf1w', label:'1W', fmt: perfFmt },
      { key:'perf1m', label:'1M', fmt: perfFmt },
      { key:'perf3m', label:'3M', fmt: perfFmt },
      { key:'perf6m', label:'6M', fmt: perfFmt },
      { key:'perfYTD', label:'YTD', fmt: perfFmt },
      { key:'perf1y', label:'1Y', fmt: perfFmt },
      { key:'relVolume', label:'Rel Vol' },
    ],
    technical: [
      ...base,
      { key:'price', label:'Price', fmt: v => v ? 'â‚¹'+v.toLocaleString('en-IN',{maximumFractionDigits:2}) : '--' },
      { key:'rsi', label:'RSI' },
      { key:'sma20', label:'SMA20', fmt: v => v ? v.toFixed(0) : '--' },
      { key:'sma50', label:'SMA50', fmt: v => v ? v.toFixed(0) : '--' },
      { key:'sma200', label:'SMA200', fmt: v => v ? v.toFixed(0) : '--' },
      { key:'beta', label:'Beta' },
      { key:'volatility', label:'Volatility%' },
      { key:'high52w', label:'52W High', fmt: v => v ? 'â‚¹'+v.toFixed(0) : '--' },
      { key:'low52w', label:'52W Low', fmt: v => v ? 'â‚¹'+v.toFixed(0) : '--' },
      { key:'pattern', label:'Pattern' },
    ],
  };
  return cols[currentSubTab] || cols.overview;
}

function perfFmt(v) { return `<span class="${v>=0?'up':'down'}">${v>=0?'+':''}${(v||0).toFixed(2)}%</span>`; }
function formatNum(n) { if (n>=10000000) return (n/10000000).toFixed(1)+'Cr'; if (n>=100000) return (n/100000).toFixed(1)+'L'; if (n>=1000) return (n/1000).toFixed(1)+'K'; return n; }
function formatCr(n) { const cr = n / 10000000; if (cr >= 100000) return (cr/100000).toFixed(1)+'L Cr'; if (cr >= 1000) return (cr/1000).toFixed(1)+'K Cr'; return cr.toFixed(0)+' Cr'; }

function renderScreenerTable() {
  const cols = getColumns();

  // Sort
  const sorted = [...filteredData].sort((a,b) => {
    const av = a[currentSort.col] ?? 0;
    const bv = b[currentSort.col] ?? 0;
    if (typeof av === 'string') return currentSort.dir === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av);
    return currentSort.dir === 'asc' ? av - bv : bv - av;
  });

  // Paginate
  const totalPages = Math.ceil(sorted.length / PAGE_SIZE);
  const start = (currentPage - 1) * PAGE_SIZE;
  const pageData = sorted.slice(start, start + PAGE_SIZE);

  // Header
  document.getElementById('screenerHead').innerHTML = '<tr>' + cols.map(c =>
    `<th class="${currentSort.col===c.key?'sorted':''}" onclick="sortScreener('${c.key}')">${c.label} ${currentSort.col===c.key?(currentSort.dir==='asc'?'â–²':'â–¼'):''}</th>`
  ).join('') + '</tr>';

  // Body
  document.getElementById('screenerBody').innerHTML = pageData.length ? pageData.map(s =>
    '<tr>' + cols.map(c => `<td>${c.fmt ? c.fmt(s[c.key], s) : (s[c.key] ?? '--')}</td>`).join('') + '</tr>'
  ).join('') : '<tr><td colspan="'+cols.length+'" style="text-align:center;padding:30px;color:var(--text-muted)">No stocks match filters</td></tr>';

  // Pagination
  const pag = document.getElementById('screenerPagination');
  pag.innerHTML = `
    <span class="page-info">Showing ${start+1}-${Math.min(start+PAGE_SIZE, sorted.length)} of ${sorted.length}</span>
    <div class="page-btns">
      <button class="page-btn" ${currentPage<=1?'disabled':''} onclick="screenerPage(${currentPage-1})">â€¹ Prev</button>
      ${Array.from({length:Math.min(totalPages,7)}, (_,i) => {
        const p = totalPages <= 7 ? i+1 : (currentPage <= 4 ? i+1 : currentPage + i - 3);
        if (p < 1 || p > totalPages) return '';
        return `<button class="page-btn ${p===currentPage?'active':''}" onclick="screenerPage(${p})">${p}</button>`;
      }).join('')}
      <button class="page-btn" ${currentPage>=totalPages?'disabled':''} onclick="screenerPage(${currentPage+1})">Next â€º</button>
    </div>`;

  updateFilterCounts();
}

function sortScreener(col) {
  if (currentSort.col === col) currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
  else { currentSort.col = col; currentSort.dir = 'desc'; }
  renderScreenerTable();
}

function screenerPage(p) { currentPage = p; renderScreenerTable(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OPTION CHAIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadOptionChain() {
  const underlying = document.getElementById('ocUnderlying').value;
  const expiry = document.getElementById('ocExpiry').value;
  const body = document.getElementById('ocBody');
  body.innerHTML = '<tr><td colspan="13" style="text-align:center;padding:40px"><div class="spinner"></div>Loading...</td></tr>';

  const res = await apiFetch(`/api/option-chain/${underlying}?expiry=${expiry}`);
  if (!res?.success || !res.data) {
    body.innerHTML = '<tr><td colspan="13" style="text-align:center;padding:40px;color:var(--red)">Failed to load option chain</td></tr>';
    return;
  }

  const d = res.data;
  document.getElementById('ocSpot').textContent = d.spot_price ? d.spot_price.toLocaleString('en-IN', {maximumFractionDigits:2}) : '--';

  // Update expiry dropdown
  if (d.expiries && d.expiries.length) {
    document.getElementById('ocExpiry').innerHTML = d.expiries.map(e => `<option value="${e}" ${e===d.expiry?'selected':''}>${formatDate(e)}</option>`).join('');
  }

  const spot = d.spot_price || 0;
  body.innerHTML = (d.strikes || []).map(s => {
    const isATM = spot && Math.abs(s.strike_price - spot) < (spot > 10000 ? 60 : 30);
    const callITM = spot && s.strike_price < spot;
    const putITM = spot && s.strike_price > spot;

    const c = s.call || {};
    const p = s.put || {};
    const cChgClass = (c.change||0) >= 0 ? 'up' : 'down';
    const pChgClass = (p.change||0) >= 0 ? 'up' : 'down';

    return `<tr>
      <td class="call-cell ${callITM?'itm-call':''} ${isATM?'atm':''}">${formatNum(c.oi||0)}</td>
      <td class="call-cell ${callITM?'itm-call':''} ${isATM?'atm':''}">${formatNum(c.oi_change||0)}</td>
      <td class="call-cell ${callITM?'itm-call':''} ${isATM?'atm':''}">${formatNum(c.volume||0)}</td>
      <td class="call-cell ${callITM?'itm-call':''} ${isATM?'atm':''}">${c.iv||'--'}</td>
      <td class="call-cell ${callITM?'itm-call':''} ${isATM?'atm':''}" style="font-weight:600">${(c.ltp||0).toFixed(2)}</td>
      <td class="call-cell ${callITM?'itm-call':''} ${isATM?'atm':''} ${cChgClass}">${(c.change||0).toFixed(2)}</td>
      <td class="strike-cell ${isATM?'atm':''}">${s.strike_price}</td>
      <td class="put-cell ${putITM?'itm-put':''} ${isATM?'atm':''} ${pChgClass}">${(p.change||0).toFixed(2)}</td>
      <td class="put-cell ${putITM?'itm-put':''} ${isATM?'atm':''}" style="font-weight:600">${(p.ltp||0).toFixed(2)}</td>
      <td class="put-cell ${putITM?'itm-put':''} ${isATM?'atm':''}">${p.iv||'--'}</td>
      <td class="put-cell ${putITM?'itm-put':''} ${isATM?'atm':''}">${formatNum(p.volume||0)}</td>
      <td class="put-cell ${putITM?'itm-put':''} ${isATM?'atm':''}">${formatNum(p.oi_change||0)}</td>
      <td class="put-cell ${putITM?'itm-put':''} ${isATM?'atm':''}">${formatNum(p.oi||0)}</td>
    </tr>`;
  }).join('');
}

function formatDate(d) {
  try { return new Date(d+'T00:00:00').toLocaleDateString('en-IN', {day:'numeric',month:'short',year:'numeric'}); }
  catch(e) { return d; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STOCK DETAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function showStock(symbol) {
  showPage('stockdetail');
  const container = document.getElementById('stockDetailContent');
  container.innerHTML = '<div style="text-align:center;padding:60px"><div class="spinner"></div>Loading...</div>';

  const res = await apiFetch(`/api/stock/${symbol}`);
  if (!res?.success || !res.data) {
    container.innerHTML = '<div style="color:var(--red);padding:40px">Failed to load stock data</div>';
    return;
  }

  const s = res.data;
  const up = (s.changePct || 0) >= 0;

  // Also get screener data for fundamentals
  const scrStock = screenerData.find(x => x.symbol === symbol) || {};

  container.innerHTML = `
    <div class="stock-header">
      <div class="stock-title-area">
        <h2>${s.symbol} <span class="stock-tag">${s.sector}</span> <span class="stock-tag">${s.industry}</span></h2>
        <div style="color:var(--text-secondary);font-size:14px;margin-top:4px">${s.name}</div>
      </div>
      <div class="stock-price-area">
        <div class="stock-price">â‚¹${(s.price||0).toLocaleString('en-IN',{maximumFractionDigits:2})}</div>
        <div class="stock-change-line ${up?'up':'down'}">${up?'â–²':'â–¼'} ${(s.change||0).toFixed(2)} (${up?'+':''}${(s.changePct||0).toFixed(2)}%)</div>
      </div>
    </div>

    <div class="stock-stats-grid">
      <div class="stat-box"><div class="stat-label">Open</div><div class="stat-value">â‚¹${(s.open||0).toLocaleString('en-IN')}</div></div>
      <div class="stat-box"><div class="stat-label">High</div><div class="stat-value">â‚¹${(s.high||0).toLocaleString('en-IN')}</div></div>
      <div class="stat-box"><div class="stat-label">Low</div><div class="stat-value">â‚¹${(s.low||0).toLocaleString('en-IN')}</div></div>
      <div class="stat-box"><div class="stat-label">Prev Close</div><div class="stat-value">â‚¹${(s.prevClose||0).toLocaleString('en-IN')}</div></div>
      <div class="stat-box"><div class="stat-label">Volume</div><div class="stat-value">${formatNum(s.volume||0)}</div></div>
      <div class="stat-box"><div class="stat-label">Avg Price</div><div class="stat-value">â‚¹${(s.avgPrice||0).toFixed(2)}</div></div>
      <div class="stat-box"><div class="stat-label">Upper Circuit</div><div class="stat-value">â‚¹${(s.upperCircuit||0).toFixed(2)}</div></div>
      <div class="stat-box"><div class="stat-label">Lower Circuit</div><div class="stat-value">â‚¹${(s.lowerCircuit||0).toFixed(2)}</div></div>
    </div>

    ${scrStock.pe ? `
    <div class="section-title" style="margin-top:24px">Fundamentals</div>
    <div class="stock-stats-grid">
      <div class="stat-box"><div class="stat-label">P/E</div><div class="stat-value">${scrStock.pe}</div></div>
      <div class="stat-box"><div class="stat-label">P/B</div><div class="stat-value">${scrStock.pb}</div></div>
      <div class="stat-box"><div class="stat-label">ROE</div><div class="stat-value">${scrStock.roe}%</div></div>
      <div class="stat-box"><div class="stat-label">Debt/Equity</div><div class="stat-value">${scrStock.debtEquity}</div></div>
      <div class="stat-box"><div class="stat-label">Net Margin</div><div class="stat-value">${scrStock.netMargin}%</div></div>
      <div class="stat-box"><div class="stat-label">EPS</div><div class="stat-value">â‚¹${scrStock.eps}</div></div>
      <div class="stat-box"><div class="stat-label">Dividend</div><div class="stat-value">${scrStock.dividend}%</div></div>
      <div class="stat-box"><div class="stat-label">Target</div><div class="stat-value">â‚¹${scrStock.targetPrice}</div></div>
    </div>

    <div class="section-title" style="margin-top:24px">Technicals</div>
    <div class="stock-stats-grid">
      <div class="stat-box"><div class="stat-label">RSI (14)</div><div class="stat-value">${scrStock.rsi}</div></div>
      <div class="stat-box"><div class="stat-label">Beta</div><div class="stat-value">${scrStock.beta}</div></div>
      <div class="stat-box"><div class="stat-label">SMA 20</div><div class="stat-value">â‚¹${scrStock.sma20}</div></div>
      <div class="stat-box"><div class="stat-label">SMA 50</div><div class="stat-value">â‚¹${scrStock.sma50}</div></div>
      <div class="stat-box"><div class="stat-label">SMA 200</div><div class="stat-value">â‚¹${scrStock.sma200}</div></div>
      <div class="stat-box"><div class="stat-label">52W High</div><div class="stat-value">â‚¹${scrStock.high52w}</div></div>
      <div class="stat-box"><div class="stat-label">52W Low</div><div class="stat-value">â‚¹${scrStock.low52w}</div></div>
      <div class="stat-box"><div class="stat-label">Pattern</div><div class="stat-value">${scrStock.pattern||'--'}</div></div>
    </div>` : ''}
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RATING TRACKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRatings() {
  const agencies = [
    { name: 'CLSA', type: 'Brokerage House', accuracy: 74, calls: 156, hits: 115 },
    { name: 'Morgan Stanley', type: 'Investment Bank', accuracy: 71, calls: 203, hits: 144 },
    { name: 'Goldman Sachs', type: 'Investment Bank', accuracy: 68, calls: 178, hits: 121 },
    { name: 'JP Morgan', type: 'Investment Bank', accuracy: 66, calls: 192, hits: 127 },
    { name: 'ICICI Securities', type: 'Brokerage House', accuracy: 63, calls: 245, hits: 154 },
    { name: 'Motilal Oswal', type: 'Brokerage House', accuracy: 61, calls: 312, hits: 190 },
    { name: 'CRISIL', type: 'Rating Agency', accuracy: 72, calls: 134, hits: 96 },
    { name: 'CARE Ratings', type: 'Rating Agency', accuracy: 58, calls: 167, hits: 97 },
  ];

  const circumference = 2 * Math.PI * 30;
  document.getElementById('ratingCards').innerHTML = agencies.map(a => {
    const offset = circumference - (a.accuracy / 100) * circumference;
    const color = a.accuracy >= 70 ? 'var(--green)' : a.accuracy >= 60 ? 'var(--yellow)' : 'var(--red)';
    return `<div class="rating-card">
      <div class="accuracy-ring">
        <svg viewBox="0 0 72 72"><circle class="ring-bg" /><circle class="ring-val" style="stroke:${color};stroke-dasharray:${circumference};stroke-dashoffset:${offset}" /></svg>
        <div class="ring-text" style="color:${color}">${a.accuracy}%</div>
      </div>
      <div class="rating-info">
        <h3>${a.name}</h3>
        <div class="rating-type">${a.type}</div>
        <div class="rating-stat">${a.hits}/${a.calls} targets hit</div>
      </div>
    </div>`;
  }).join('');

  const calls = [
    { agency:'CLSA', stock:'RELIANCE', rating:'Buy', target:3200, cmp:2850, date:'2026-02-10', status:'Active' },
    { agency:'Morgan Stanley', stock:'TCS', rating:'Hold', target:4100, cmp:4050, date:'2026-02-08', status:'Active' },
    { agency:'Goldman Sachs', stock:'HDFCBANK', rating:'Buy', target:1950, cmp:1720, date:'2026-02-05', status:'Active' },
    { agency:'ICICI Sec', stock:'INFY', rating:'Buy', target:2000, cmp:1850, date:'2026-02-03', status:'Active' },
    { agency:'Motilal Oswal', stock:'BAJFINANCE', rating:'Sell', target:6200, cmp:6800, date:'2026-01-28', status:'Miss' },
    { agency:'JP Morgan', stock:'SBIN', rating:'Buy', target:870, cmp:810, date:'2026-01-25', status:'Active' },
    { agency:'CRISIL', stock:'TATAMOTORS', rating:'Buy', target:780, cmp:720, date:'2026-01-20', status:'Hit' },
    { agency:'CARE Ratings', stock:'SUNPHARMA', rating:'Hold', target:1850, cmp:1790, date:'2026-01-15', status:'Active' },
    { agency:'Goldman Sachs', stock:'ITC', rating:'Buy', target:510, cmp:460, date:'2026-01-10', status:'Hit' },
    { agency:'CLSA', stock:'MARUTI', rating:'Buy', target:12500, cmp:11200, date:'2026-01-08', status:'Active' },
  ];

  document.getElementById('callsBody').innerHTML = calls.map(c => {
    const upside = ((c.target - c.cmp) / c.cmp * 100).toFixed(1);
    const rBadge = c.rating === 'Buy' ? 'badge-buy' : c.rating === 'Sell' ? 'badge-sell' : 'badge-hold';
    const sBadge = c.status === 'Hit' ? 'badge-hit' : c.status === 'Miss' ? 'badge-miss' : 'badge-active';
    return `<tr>
      <td>${c.agency}</td>
      <td><span class="stock-link" onclick="showStock('${c.stock}')">${c.stock}</span></td>
      <td><span class="badge ${rBadge}">${c.rating}</span></td>
      <td style="font-weight:600">â‚¹${c.target.toLocaleString()}</td>
      <td>â‚¹${c.cmp.toLocaleString()}</td>
      <td class="${upside>0?'up':'down'}">${upside>0?'+':''}${upside}%</td>
      <td style="color:var(--text-muted)">${c.date}</td>
      <td><span class="badge ${sBadge}">${c.status}</span></td>
    </tr>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEARNING HUB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const articles = [
  { title:'What is a Stock?', desc:'Understanding equities, shares, and ownership in companies. The building block of all market analysis.', level:'beginner', time:'5 min', cat:'Basics' },
  { title:'Reading Financial Statements', desc:'How to interpret Balance Sheets, P&L Statements, and Cash Flow statements like a professional analyst.', level:'beginner', time:'12 min', cat:'Fundamentals' },
  { title:'P/E Ratio Deep Dive', desc:'Why the Price-to-Earnings ratio matters, its limitations, and how to compare across sectors.', level:'beginner', time:'8 min', cat:'Valuation' },
  { title:'Introduction to Technical Analysis', desc:'Chart patterns, support/resistance, and why price action matters for timing entries and exits.', level:'beginner', time:'10 min', cat:'Technical' },
  { title:'Understanding Options', desc:'Calls, puts, strike prices, and expiry â€” the complete foundation for derivatives trading.', level:'intermediate', time:'15 min', cat:'Derivatives' },
  { title:'Option Greeks Explained', desc:'Delta, Gamma, Theta, Vega â€” what they mean and how they affect your P&L in real-time.', level:'intermediate', time:'18 min', cat:'Derivatives' },
  { title:'DCF Valuation Model', desc:'Building a Discounted Cash Flow model from scratch. Step-by-step with real company examples.', level:'intermediate', time:'20 min', cat:'Valuation' },
  { title:'Risk Management Frameworks', desc:'Position sizing, stop losses, Kelly Criterion, and how professional traders manage drawdowns.', level:'intermediate', time:'14 min', cat:'Risk' },
  { title:'Black-Scholes Model', desc:'The mathematics behind option pricing. Deriving the formula and understanding its assumptions.', level:'advanced', time:'25 min', cat:'Quant' },
  { title:'Monte Carlo Simulations', desc:'Using random sampling to model portfolio returns, VaR calculations, and stress testing strategies.', level:'advanced', time:'22 min', cat:'Quant' },
  { title:'Factor Investing & Smart Beta', desc:'Momentum, Value, Quality, Low Volatility factors â€” building systematic strategies that work.', level:'advanced', time:'20 min', cat:'Quant' },
  { title:'Stochastic Calculus for Finance', desc:'Brownian motion, Ito\'s lemma, and the mathematical foundations of modern quantitative finance.', level:'advanced', time:'30 min', cat:'Quant' },
];

function renderArticles(filter = 'all') {
  const filtered = filter === 'all' ? articles : articles.filter(a => a.level === filter);
  document.getElementById('articlesGrid').innerHTML = filtered.map(a => `
    <div class="article-card">
      <span class="article-level level-${a.level}">${a.level}</span>
      <div class="article-title">${a.title}</div>
      <div class="article-desc">${a.desc}</div>
      <div class="article-meta">
        <span>ğŸ“– ${a.time} read</span>
        <span>ğŸ“‚ ${a.cat}</span>
      </div>
    </div>
  `).join('');
}

function filterArticles(level) {
  document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  renderArticles(level);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INITIALIZE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  // Load everything
  await Promise.all([
    loadIndices(),
    loadMarketData(),
    loadScreener(),
  ]);

  renderRatings();
  renderArticles();

  // Auto-refresh
  setInterval(async () => {
    await loadIndices();
    await loadMarketData();
  }, 30000);

  // Refresh screener every 60s
  setInterval(loadScreener, 60000);
}

init();
</script>
</body>
</html>
